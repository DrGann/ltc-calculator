<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Èï∑ÁÖßË®àÁÆó">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="description" content="Èï∑ÁÖßÊúçÂãôÈ°çÂ∫¶Ë®àÁÆóÂ∑•ÂÖ∑ - B/CÁ¢º„ÄÅGÁ¢ºÂÆåÊï¥Ë®àÁÆó">
    
    <title>Èï∑ÁÖßÈ°çÂ∫¶Ë®àÁÆóÂ∑•ÂÖ∑</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- iOS PWA Icon (base64 PNG) -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAHbklEQVR4nO3de4hVVRTH8d+ZMR0184FmJoXYQ6NCKSMtKqPoQREVBPWH9IJIC3pREBX9ERREDwqKiIp6UUFQRAX1oEcRFVFRREVFRRQRFREVTWbm3PljX2fmzpyZuffMvWfvvdbvA8LM3Hvu3Wfvb9ZZZ629j5OZCRDCQNsNALqJQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVD+FwId+2+3m4AuKXWgLc4fQB+i/Q7+95dS8cXjdxrfJVoC2CYH26y4f0O5A92hJB34WzQRN7Pc7v+ofKBL/TvsVNCQoL0mB9sktbmQYrsJ6BoCvTvLqdhftWxVG/xewu1GfyjwNTu5aPg1O1Tx1+xlBIL2mhxst9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrSh3oYL2muLZKbS6k0G4CuqbUgQ7Wa4prq9TmQgrtJqBrShvoTicTfb5Ee00Othkqk4Nt1u+h3UJJEfqU9DnWTpMD9odrw51O6JJSBzpa70LtrrrPNzlgfwjWa3KwzVKbCym0m4CuKXWgg/Wa4toqtbmQQrsJ6JpSBzpYrymuravJvbifgE4qdaCD9Zri2iq1uZBCuwnomtIGulNJh8/Q2mtysM1SmQsptJuArimngU63GYq/Zu/pX9e1VepQhv7QrKdLSh3oYL0m+0PBNmP/X8Ht/1H5QJf65dTpZKLPl2ivycE2Q2VysM1SmwsptJuArik1kk3kl5uLlvB7CKfbDMVfc/bkYJulNhdSaDcBXUOgEQqBRigEGqEQaIRCoBEKgUYoBBqhEGiEQqARCoFGKAQaoRBohEKgEQqBRigEGqEQaIRCoBEKgUYoBBqhEGiEQqARCoFGKAQaoRBohEKgEQqBRigEGqEQaIRCoBEKgUYoBBqhEGiEQqARCoFGKAQaoRBohEKgEQqBRigEGqEQaIRCoBEKgUYoBBqhEGiEQqARCoFGKKUOdOy/3W4CuqTUgba4f/t/hf8V/ldAoBEKgUYoBBqhEGiEUupAd+hLjehXpQ50sF5TXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXVPqQAfrtcW1VWpzIYV2E9A1pQ50sF5bXFulNhdSaDcBXUOgEQqBRigEGqEQaIRCoBEKgUYoBBqhEGiEQqARCoFGKKUOdCeT4rTX5GCboTI52Gb9HtotlBShT0mfY+00OWB/CLbW5EDbWH8odaBL/Tvs1E+B3aJJbS6k0G4CuqbUgQ7WO4trq9TmQgrtJqBrSh3oYL2zuLZKbS6k0G4CuqbUgQ7WO4trq9TmQgrtJqBrSh3oYL2zuLZKbS6k0G4CuqbUgQ7WO4trq9TmQgrtJqBrSh3oYL2zuLZKbS6k0G4CuqbUgQ7WO4trq9TmQgrtJqBrSh3oYL2zuLZKbS6k0G4CuoZAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCMUAo1QCDRCIdAIhUAjFAKNUAg0QiHQCIVAIxQCjVAINEIh0AiFQCOUfwF3cE/hLxO9oQAAAABJRU5ErkJggg==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html, body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        header {
            text-align: center;
            padding: 16px 0;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        header p {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            margin-bottom: 12px;
            transition: opacity 0.3s ease;
        }

        .card.locked {
            opacity: 0.4;
            pointer-events: none;
            position: relative;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }

        .card-title .step {
            margin-left: auto;
            font-size: 0.7rem;
            font-weight: 500;
            color: #64748b;
            background: rgba(255,255,255,0.08);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .card-title .step.active {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
        }

        .card-title .step.done {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .lock-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 14px;
            z-index: 10;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 8px;
        }

        .card.locked .lock-overlay {
            display: flex;
        }

        .lock-icon {
            font-size: 1.5rem;
        }

        .lock-text {
            font-size: 0.82rem;
            color: #94a3b8;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
        }

        .selector-btn {
            padding: 10px 6px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            font-size: 0.88rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .selector-btn:active { transform: scale(0.97); }

        .selector-btn.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .selector-btn .amount {
            display: block;
            font-size: 0.68rem;
            color: #94a3b8;
            margin-top: 2px;
        }

        .selector-btn.active .amount { color: rgba(255, 255, 255, 0.85); }

        .identity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .identity-btn {
            padding: 12px 6px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            font-size: 0.82rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .identity-btn:active { transform: scale(0.97); }
        .identity-btn.active { border-color: transparent; color: white; }

        .identity-btn[data-rate="0"].active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        .identity-btn[data-rate="5"].active {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }
        .identity-btn[data-rate="16"].active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .identity-btn .rate {
            display: block;
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        .identity-btn.active .rate { color: rgba(255, 255, 255, 0.85); }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            margin-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .toggle-label { font-size: 0.88rem; color: #e2e8f0; }
        .toggle-sublabel {
            font-size: 0.72rem;
            color: #94a3b8;
            margin-top: 2px;
            line-height: 1.4;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch.active { background: linear-gradient(135deg, #f97316, #ea580c); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after { transform: translateX(22px); }

        /* Â∑≤ÈÅ∏ÊëòË¶Å */
        .selection-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .summary-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .summary-tag.orange {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 60px;
            padding: 10px 6px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            color: #94a3b8;
            font-size: 0.75rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .tab-btn:active { transform: scale(0.98); }
        .tab-btn.active { border-color: transparent; color: white; }

        .tab-btn.active.tab-bc { background: linear-gradient(135deg, #3b82f6, #6366f1); }
        .tab-btn.active.tab-g { background: linear-gradient(135deg, #f59e0b, #d97706); }

        /* Services */
        .service-section { margin-bottom: 8px; }

        .collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .collapse-header h3 {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .collapse-header h3.bc-header { color: #60a5fa; }
        .collapse-header h3.g-header { color: #fbbf24; }
        .collapse-header h3.sc-header { color: #22d3ee; }

        /* SCÁ¢ºÈéñÂÆöÊ®£Âºè */
        #scContainer {
            position: relative;
            margin-top: 10px;
        }
        
        #scContainer.sc-locked {
            opacity: 0.5;
        }
        
        .sc-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            z-index: 10;
        }
        
        .sc-lock-overlay .lock-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .sc-lock-overlay .lock-text {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        .sc-placeholder {
            padding: 12px;
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.1);
            border-radius: 10px;
        }

        .collapse-icon {
            font-size: 0.7rem;
            color: #94a3b8;
            transition: transform 0.3s ease;
        }

        .collapse-icon.open { transform: rotate(180deg); }

        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapse-content.open { max-height: 5000px; }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding-top: 6px;
        }

        .service-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: opacity 0.2s;
        }

        .service-item.disabled { opacity: 0.3; }

        .service-item.g-item { border-left: 3px solid rgba(251, 191, 36, 0.5); }
        .service-item.c-item { border-left: 3px solid rgba(168, 85, 247, 0.5); }
        .service-item.bb-item { border-left: 3px solid rgba(34, 197, 94, 0.5); }
        .service-item.bc-item { border-left: 3px solid rgba(236, 72, 153, 0.5); }
        .service-item.sc-item { border-left: 3px solid rgba(6, 182, 212, 0.5); }

        .service-info {
            flex: 1;
            min-width: 0;
            padding-right: 6px;
        }

        .service-name {
            font-size: 0.82rem;
            color: #e2e8f0;
            font-weight: 500;
        }

        .service-code {
            font-size: 0.7rem;
            color: #64748b;
            margin-right: 4px;
        }

        .service-code.c-code { color: #a855f7; }
        .service-code.g-code { color: #fbbf24; }
        .service-code.bb-code { color: #22c55e; }
        .service-code.bc-code { color: #ec4899; }
        .service-code.sc-code { color: #22d3ee; }

        .service-price {
            font-size: 0.72rem;
            color: #94a3b8;
            margin-top: 1px;
        }

        .service-note {
            font-size: 0.68rem;
            color: #f97316;
            margin-top: 3px;
            line-height: 1.35;
        }

        .service-controls {
            display: flex;
            align-items: center;
            gap: 3px;
            flex-shrink: 0;
            padding-top: 2px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .qty-btn:active { transform: scale(0.92); }

        .qty-btn.minus { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .qty-btn.plus { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .qty-btn.plus5 { 
            background: rgba(59, 130, 246, 0.2); 
            color: #60a5fa; 
            font-size: 0.7rem;
            font-weight: 600;
        }
        .qty-btn:disabled { opacity: 0.25; cursor: not-allowed; }

        .qty-display {
            width: 32px;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 600;
            color: #94a3b8;
        }

        .qty-display.has-value { color: #60a5fa; }

        /* Ë®àÁÆóÊòéÁ¥∞ÂçÄ */
        .calc-detail {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 10px;
            margin-top: 14px;
            overflow: hidden;
        }

        .calc-detail.g-detail {
            background: rgba(251, 191, 36, 0.08);
            border-color: rgba(251, 191, 36, 0.15);
        }

        .calc-detail.sc-detail {
            background: rgba(6, 182, 212, 0.08);
            border-color: rgba(6, 182, 212, 0.15);
        }

        .calc-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
        }

        .calc-detail-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #60a5fa;
        }

        .calc-detail.g-detail .calc-detail-title { color: #fbbf24; }
        .calc-detail.sc-detail .calc-detail-title { color: #22d3ee; }

        .calc-detail-toggle {
            font-size: 0.7rem;
            color: #94a3b8;
            transition: transform 0.3s;
        }

        .calc-detail-toggle.open { transform: rotate(180deg); }

        .calc-detail-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .calc-detail-content.open { max-height: 2000px; }

        .calc-item {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .calc-item:last-child { border-bottom: none; }

        .calc-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .calc-item-name {
            font-size: 0.82rem;
            color: #e2e8f0;
            font-weight: 500;
        }

        .calc-item-name .code {
            color: #64748b;
            margin-right: 4px;
            font-size: 0.75rem;
        }

        .calc-item-qty {
            font-size: 0.8rem;
            color: #60a5fa;
            font-weight: 600;
        }

        .calc-item-rows {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding-left: 8px;
            border-left: 2px solid rgba(255,255,255,0.1);
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
        }

        .calc-row-label { color: #94a3b8; }
        .calc-row-value { color: #e2e8f0; }
        .calc-row-value .copay { color: #f97316; margin-left: 6px; }

        .calc-subtotal {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            font-size: 0.82rem;
        }

        .calc-subtotal-label {
            color: #94a3b8;
            font-weight: 500;
        }

        .calc-subtotal-value {
            font-weight: 600;
        }

        .calc-subtotal-value .amount { color: #60a5fa; }
        .calc-subtotal-value .copay { color: #f97316; margin-left: 8px; }

        /* Á∏ΩË®àÂçÄ */
        .grand-total {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 14px;
            margin-top: 14px;
        }

        .grand-total-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 10px;
        }

        .grand-total-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.82rem;
        }

        .grand-total-row.main {
            padding-top: 10px;
            margin-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        .grand-total-label { color: #94a3b8; }
        .grand-total-value { font-weight: 600; color: #e2e8f0; }
        .grand-total-value.total { color: #60a5fa; }
        .grand-total-value.copay { color: #f97316; }
        .grand-total-value.remain { color: #22c55e; }
        .grand-total-value.negative { color: #ef4444; }

        /* Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 14px;
        }

        .action-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.82rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-btn:active { transform: scale(0.97); }

        .action-btn.reset {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-btn.copy {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .action-btn.export {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ÂåØÂá∫ÂúñÁâáÁî®ÁöÑÈö±ËóèÂçÄÂ°ä */
        .export-canvas {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 400px;
            background: linear-gradient(135deg, #1e3a5f 0%, #1e1b4b 100%);
            font-family: 'Noto Sans TC', sans-serif;
            padding: 24px;
            color: #f1f5f9;
        }

        .export-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }

        .export-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .export-header .date {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .export-section {
            margin-bottom: 16px;
            padding: 14px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
        }

        .export-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .export-section-title.orange { color: #fbbf24; }
        .export-section-title.cyan { color: #22d3d1; }
        .export-section-title.purple { color: #a78bfa; }

        .export-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.82rem;
        }

        .export-row-label { color: #94a3b8; }
        .export-row-value { color: #e2e8f0; font-weight: 500; }
        .export-row-value.highlight { color: #60a5fa; }
        .export-row-value.green { color: #22c55e; }
        .export-row-value.red { color: #ef4444; }
        .export-row-value.orange { color: #f97316; }

        .export-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .export-item:last-child { border-bottom: none; }

        .export-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .export-item-name {
            font-size: 0.82rem;
            color: #e2e8f0;
        }

        .export-item-name .code {
            color: #64748b;
            margin-right: 4px;
        }

        .export-item-detail {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .export-total {
            margin-top: 16px;
            padding: 14px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .export-total-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .export-total-label { color: #a78bfa; font-weight: 500; }
        .export-total-value { color: #f97316; font-weight: 700; font-size: 1rem; }

        .export-footer {
            margin-top: 16px;
            text-align: center;
            font-size: 0.7rem;
            color: #64748b;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(30, 27, 75, 0.95);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            padding: 14px 22px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #f1f5f9;
            font-size: 0.88rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 200;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .hidden { display: none !important; }

        .info-note {
            font-size: 0.72rem;
            color: #94a3b8;
            padding: 8px 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            margin-top: 10px;
            line-height: 1.4;
        }

        .info-note strong { color: #f97316; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Èï∑ÁÖßÈ°çÂ∫¶Ë®àÁÆóÂ∑•ÂÖ∑</h1>
            <p>B/CÁ¢º„ÉªDÁ¢º„ÉªGÁ¢º ÂÆåÊï¥Ë®àÁÆó</p>
        </header>

        <!-- Step 1: CMSÁ≠âÁ¥ö -->
        <div class="card" id="cmsCard">
            <div class="card-title">
                CMSÁ≠âÁ¥ö
                <span class="step active" id="step1">Step 1</span>
            </div>
            <div class="selector-grid" id="cmsGrid">
                <button class="selector-btn" data-level="2" onclick="selectCMS(2)">2Á¥ö<span class="amount">10,020</span></button>
                <button class="selector-btn" data-level="3" onclick="selectCMS(3)">3Á¥ö<span class="amount">15,460</span></button>
                <button class="selector-btn" data-level="4" onclick="selectCMS(4)">4Á¥ö<span class="amount">18,580</span></button>
                <button class="selector-btn" data-level="5" onclick="selectCMS(5)">5Á¥ö<span class="amount">24,100</span></button>
                <button class="selector-btn" data-level="6" onclick="selectCMS(6)">6Á¥ö<span class="amount">28,070</span></button>
                <button class="selector-btn" data-level="7" onclick="selectCMS(7)">7Á¥ö<span class="amount">32,090</span></button>
                <button class="selector-btn" data-level="8" onclick="selectCMS(8)">8Á¥ö<span class="amount">36,180</span></button>
            </div>
        </div>

        <!-- Step 2: Ë∫´‰ªΩÂà• -->
        <div class="card locked" id="identityCard">
            <div class="lock-overlay">
                <span class="lock-icon">üîí</span>
                <span class="lock-text">Ë´ãÂÖàÈÅ∏Êìá CMS Á≠âÁ¥ö</span>
            </div>
            <div class="card-title">
                Ë∫´‰ªΩÂà•
                <span class="step" id="step2">Step 2</span>
            </div>
            <div class="identity-grid" id="identityGrid">
                <button class="identity-btn" data-rate="0" data-identity="low" onclick="selectIdentity('low')">‰ΩéÊî∂ÂÖ•Êà∂<span class="rate">B/C 0%</span></button>
                <button class="identity-btn" data-rate="5" data-identity="midLow" onclick="selectIdentity('midLow')">‰∏≠‰ΩéÊî∂ÂÖ•<span class="rate">B/C 5%</span></button>
                <button class="identity-btn" data-rate="16" data-identity="general" onclick="selectIdentity('general')">‰∏ÄËà¨Êà∂<span class="rate">B/C 16%</span></button>
            </div>
            <div class="toggle-row">
                <div>
                    <div class="toggle-label">ËÅòÂÉ±Â§ñÁ±çÁúãË≠∑Â∑•</div>
                    <div class="toggle-sublabel">B/CÁ¢ºÂÉÖ30%È°çÂ∫¶ÔºåÈôêCÁ¢º+BA09/BA09a/BD03</div>
                </div>
                <div class="toggle-switch" id="foreignToggle"></div>
            </div>
            <div class="selection-summary" id="selectionSummary"></div>
        </div>

        <!-- Step 3: ÊúçÂãôÈ†ÖÁõÆ -->
        <div class="card locked" id="serviceCard">
            <div class="lock-overlay">
                <span class="lock-icon">üîí</span>
                <span class="lock-text">Ë´ãÂÖàÂÆåÊàê Step 1 & 2</span>
            </div>
            <div class="card-title">
                ÊúçÂãôÈ†ÖÁõÆ
                <span class="step" id="step3">Step 3</span>
            </div>
            
            <div class="tabs">
                <button class="tab-btn tab-bc active" data-tab="bc">B/CÁ¢º</button>
                <button class="tab-btn tab-g" data-tab="g">G/SCÁ¢º</button>
            </div>

            <div id="bcContainer"></div>
            <div id="gContainer" class="hidden"></div>
            <div id="scContainer" class="hidden"></div>

            <div class="info-note" id="foreignNote" style="display:none;">
                <strong>‚ö†Ô∏è Â§ñÁ±çÁúãË≠∑Ôºö</strong>B/CÁ¢ºÂÉÖ30%È°çÂ∫¶ÔºåÈôêCÁ¢ºÂèäBA09/BA09a/BD03„ÄÇDÁ¢º/GÁ¢º‰∏çÂèóÂΩ±Èüø„ÄÇ
            </div>
        </div>

        <!-- Ë®àÁÆóÊòéÁ¥∞ -->
        <div id="bcCalcDetail" class="calc-detail hidden">
            <div class="calc-detail-header" id="bcCalcToggle">
                <span class="calc-detail-title">B/CÁ¢º Ë®àÁÆóÊòéÁ¥∞</span>
                <span class="calc-detail-toggle open">‚ñº</span>
            </div>
            <div class="calc-detail-content open" id="bcCalcContent"></div>
            <div class="calc-subtotal" id="bcSubtotal"></div>
        </div>

        <div id="gCalcDetail" class="calc-detail g-detail hidden">
            <div class="calc-detail-header" id="gCalcToggle">
                <span class="calc-detail-title">GÁ¢º Ë®àÁÆóÊòéÁ¥∞</span>
                <span class="calc-detail-toggle open">‚ñº</span>
            </div>
            <div class="calc-detail-content open" id="gCalcContent"></div>
            <div class="calc-subtotal" id="gSubtotal"></div>
        </div>

        <div id="scCalcDetail" class="calc-detail sc-detail hidden">
            <div class="calc-detail-header" id="scCalcToggle">
                <span class="calc-detail-title">SCÁ¢º Ë®àÁÆóÊòéÁ¥∞</span>
                <span class="calc-detail-toggle open">‚ñº</span>
            </div>
            <div class="calc-detail-content open" id="scCalcContent"></div>
            <div class="calc-subtotal" id="scSubtotal"></div>
        </div>

        <!-- Á∏ΩË®à -->
        <div class="grand-total" id="grandTotal">
            <div class="grand-total-title">È°çÂ∫¶Á∏ΩË¶Ω</div>
            <div id="grandTotalContent"></div>
        </div>

        <div class="quick-actions">
            <button class="action-btn reset" id="resetBtn">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
            <button class="action-btn copy" id="copyBtn" disabled>Ë§áË£ΩÁµêÊûú</button>
            <button class="action-btn export" id="exportBtn" disabled>ÂåØÂá∫ÂúñÁâá</button>
        </div>

        <!-- ÂåØÂá∫ÂúñÁâáÁî®ÁöÑÈö±ËóèÂçÄÂ°ä -->
        <div class="export-canvas" id="exportCanvas"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== Ë≥áÊñôÂÆöÁæ© =====
        
        const CMS_BC_QUOTA = {
            2: 10020, 3: 15460, 4: 18580, 5: 24100, 6: 28070, 7: 32090, 8: 36180
        };

        const D_QUOTA = 1840;

        const CMS_G_QUOTA = {
            2: 32340, 3: 32340, 4: 32340, 5: 32340, 6: 32340, 7: 48510, 8: 48510
        };

        // SCÁ¢ºÁü≠ÁÖßÊúçÂãôÈ°çÂ∫¶ÔºàÂÉÖÈôêËÅòÂÉ±Â§ñÁ±çÁúãË≠∑Â∑•Ôºâ
        const CMS_SC_QUOTA = {
            2: 87780, 3: 87780, 4: 87780, 5: 87780, 6: 87780, 7: 71610, 8: 71610
        };

        const BB_PRICES = {
            2: { full: 675, half: 340 },
            3: { full: 840, half: 420 },
            4: { full: 920, half: 460 },
            5: { full: 1045, half: 525 },
            6: { full: 1130, half: 565 },
            7: { full: 1210, half: 605 },
            8: { full: 1285, half: 645 }
        };

        const BC_PRICES = {
            2: { full: 625, half: 315 },
            3: { full: 760, half: 380 },
            4: { full: 785, half: 395 },
            5: { full: 880, half: 440 },
            6: { full: 960, half: 480 },
            7: { full: 980, half: 490 },
            8: { full: 1040, half: 520 }
        };

        const COPAY_RATES = {
            bc: { low: 0, midLow: 5, general: 16 },
            d: { low: 0, midLow: 9, general: 27 },
            g: { low: 0, midLow: 5, general: 16 },
            sc: { low: 0, midLow: 5, general: 16 }
        };

        const IDENTITY_NAMES = {
            low: '‰ΩéÊî∂ÂÖ•Êà∂',
            midLow: '‰∏≠‰ΩéÊî∂ÂÖ•',
            general: '‰∏ÄËà¨Êà∂'
        };

        const FOREIGN_B_ALLOWED = ['BA09', 'BA09a', 'BD03'];

        // BÁ¢ºÊúçÂãô
        const B_SERVICES = [
            { category: 'Ë∫´È´îÁÖßÈ°ß', items: [
                { code: 'BA01', name: 'Âü∫Êú¨Ë∫´È´îÊ∏ÖÊΩî', price: 260, 
                  note: '‚äò‰∏çÂèØËàáBA07/BA23ÂêåÊôÇÊÆµ‰ΩµÁî®ÔΩú‰∏ÄÊó•ÂéüÂâá1ÁµÑÔºåÂøÖË¶ÅÊôÇÊó©ÊôöÂêÑ1ÁµÑ' },
                { code: 'BA02', name: 'Âü∫Êú¨Êó•Â∏∏ÁÖßÈ°ß', price: 195, unit: '/30ÂàÜ', 
                  note: '‚äò‰∏çÂæóËàáÂÖ∂‰ªñÁµÑÂêà‰ΩµÁî®ÔΩúÊó•Èôê3Â∞èÊôÇ(6ÁµÑ)' },
                { code: 'BA03', name: 'Ê∏¨ÈáèÁîüÂëΩÂæµË±°', price: 35, 
                  note: 'Áç®Á´ãÊñºÂÖ∂‰ªñÊúçÂãôÊôÇ‰ΩøÁî®ÔºåÊúçÂãôÂâçÂæåËßÄÂØü‰∏çÈÅ©Áî®' },
                { code: 'BA04', name: 'ÂçîÂä©ÈÄ≤È£üÊàñÁÆ°ÁÅåÈ§µÈ£ü', price: 130, unit: '/È§ê', 
                  note: '‰∏ÄÈ§êÁÇ∫‰∏ÄÁµÑÂêà' },
                { code: 'BA05', name: 'È§êÈ£üÁÖßÈ°ß', price: 310, 
                  note: 'ÂÇôÈ§ê‰∏ÄÊ¨°ÁÇ∫‰∏ÄÁµÑÂêàÔΩúÂñÆÁ¥îÂä†ÁÜ±È£ØËèúÂ±¨BA04' },
                { code: 'BA07', name: 'ÂçîÂä©Ê≤êÊµ¥ÂèäÊ¥óÈ†≠', price: 325, 
                  note: '‚äò‰∏çÂèØËàáBA01/BA23ÂêåÊôÇÊÆµ‰ΩµÁî®ÔΩúÂ∑≤ÂåÖÂê´BA01„ÄÅBA23ÂÖßÂÆπ' },
                { code: 'BA08', name: 'Ë∂≥ÈÉ®ÁÖßË≠∑', price: 500, 
                  note: 'ÈúÄÂÆåÊàêË°õÁ¶èÈÉ®Ë™çÂèØË®ìÁ∑¥ÔΩúÊó•Â∏∏ÊåáÁî≤‰øÆÂâ™Â±¨BA02' },
                { code: 'BA10', name: 'ÁøªË∫´ÊãçËÉå', price: 155, 
                  note: 'ÂÆåÊï¥ÂØ¶ÊñΩ‰∏ÄÊ¨°ÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰Ωç' },
                { code: 'BA11', name: 'ËÇ¢È´îÈóúÁØÄÊ¥ªÂãï', price: 195, 
                  note: 'ÂÆåÊï¥ÂØ¶ÊñΩ‰∏ÄÊ¨°ÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰Ωç' },
                { code: 'BA23', name: 'ÂçîÂä©Ê¥óÈ†≠', price: 200, 
                  note: '‚äò‰∏çÂèØËàáBA01/BA07ÂêåÊôÇÊÆµ‰ΩµÁî®' },
                { code: 'BA24', name: 'ÂçîÂä©ÊéíÊ≥Ñ', price: 220, 
                  note: 'Âü∑Ë°åBA01ÊàñBA07ÈÅéÁ®ã‰∏≠ÂêåÊôÇÂü∑Ë°åÂâá‰∏çÂæó‰ΩµË®à' },
            ]},
            { category: 'Â§ñÂá∫ÂçîÂä©', items: [
                { code: 'BA12', name: 'ÂçîÂä©‰∏ä‰∏ãÊ®ìÊ¢Ø', price: 130, 
                  note: 'Èôê„ÄåÁßª‰ΩçÂïèÈ°å„ÄçÊàñ„Äå‰∏ä‰∏ãÊ®ìÊ¢ØÂïèÈ°å„ÄçËÄÖÔΩú‰∏çÈÅ©Áî®ÈõªÊ¢Ø/Áà¨Ê¢ØÊ©ü/Ê®ìÊ¢ØÂçáÈôçÊ§Ö' },
                { code: 'BA13', name: 'Èô™ÂêåÂ§ñÂá∫', price: 195, unit: '/30ÂàÜ', 
                  note: '‰∏çÂåÖÊã¨‰∫§ÈÄöÂ∑•ÂÖ∑Ë≤ªÁî®' },
                { code: 'BA14', name: 'Èô™ÂêåÂ∞±ÈÜ´', price: 685, 
                  note: '1.5hrÂÖßÔΩú‚äò‰∏çÈÅ©Áî®ÂÆöÊúüÂºèÂæ©ÂÅ•ÊàñÈÄèÊûêÔΩúË∂ÖÈÅé1.5hrÁî®BA13Ë®à' },
            ]},
            { category: 'ÂÆ∂Âãô/‰ª£Ë≥º', items: [
                { code: 'BA15', name: 'ÂÆ∂ÂãôÂçîÂä©', price: 195, unit: '/30ÂàÜ', 
                  note: 'ÈùûÁç®Â±ÖÂÖ±Áî®ÂçÄÂüüÂÉÖÊîØ‰ªò50%' },
                { code: 'BA16', name: '‰ª£Ë≥º‰ª£È†ò‰ª£ÈÄÅ', price: 130, 
                  note: '5kmÂÖßÔΩúÂåÖÂê´ÂÆ∂‰∫∫Áâ©ÂìÅÂâáÂÉÖÊîØ‰ªò50%' },
            ]},
            { category: 'ÁÆ°Ë∑ØÁÖßË≠∑', items: [
                { code: 'BA17a', name: '‰∫∫Â∑•Ê∞£ÈÅìÁÆ°ÂÖßÂàÜÊ≥åÁâ©ÊäΩÂê∏', price: 75, 
                  note: 'Êó•Èôê3ÁµÑÔΩúÈúÄÁâπÊÆäË®ìÁ∑¥' },
                { code: 'BA17b', name: 'Âè£ËÖîÂÖßÂàÜÊ≥åÁâ©ÊäΩÂê∏', price: 65, 
                  note: 'Êó•Èôê3ÁµÑÔΩúÈúÄÁâπÊÆäË®ìÁ∑¥' },
                { code: 'BA17c', name: 'Â∞øÁÆ°ÂèäÈºªËÉÉÁÆ°Ê∏ÖÊΩîÂõ∫ÂÆö', price: 50, 
                  note: 'ÈÄ±Èôê7ÁµÑ' },
                { code: 'BA17d1', name: 'Ë°ÄÁ≥ñÊ©üÈ©óË°ÄÁ≥ñ', price: 50, 
                  note: 'Êó•Èôê1ÁµÑ' },
                { code: 'BA17d2', name: 'ÁîòÊ≤πÁêÉÈÄö‰æø', price: 50, 
                  note: 'ÈÄ±Èôê3ÁµÑ' },
                { code: 'BA17e', name: '‰æùÊåáÁ§∫ÁΩÆÂÖ•Ëó•Áõí', price: 50, 
                  note: 'ÈÄ±Èôê1ÁµÑ' },
            ]},
            { category: 'ÂÆâÂÖ®ÁúãË¶ñ/Èô™‰º¥', items: [
                { code: 'BA18', name: 'ÂÆâÂÖ®ÁúãË¶ñ', price: 200, unit: '/30ÂàÜ', 
                  note: '‚ö†ÈôêÂøÉÊô∫ÈöúÁ§ôËÄÖÔΩú‚äò‰∏çÂæóËàáÂÖ∂‰ªñÁµÑÂêà‰ΩµÁî®ÔºåÂèØÊé•Á∫å' },
                { code: 'BA20', name: 'Èô™‰º¥ÊúçÂãô', price: 175, unit: '/30ÂàÜ', 
                  note: '‚äò‰∏çÂæóËàáÂÖ∂‰ªñÁµÑÂêà‰ΩµÁî®ÔºåÂèØÊé•Á∫å' },
                { code: 'BA22', name: 'Â∑°Ë¶ñÊúçÂãô', price: 130, 
                  note: '6am-8pmËá≥Â∞ë3Ê¨°ÔΩú‚äò‰∏çÂæóÊê≠ÈÖçÂÖ∂‰ªñÁÖßÈ°ßÁµÑÂêà' },
            ]},
            { category: 'Âà∞ÂÆÖÊ≤êÊµ¥Ëªä', items: [
                { code: 'BA09', name: 'Âà∞ÂÆÖÊ≤êÊµ¥Ëªä(‰∏ÄÂûã)', price: 2200, 
                  note: '‚úìÂ§ñÁ±çÂèØÁî®ÔΩúËá≥Â∞ë3‰ΩçÁÖßÊúçÂì°' },
                { code: 'BA09a', name: 'Âà∞ÂÆÖÊ≤êÊµ¥Ëªä(‰∫åÂûã)', price: 2500, 
                  note: '‚úìÂ§ñÁ±çÂèØÁî®ÔΩúÊúâÁÆ°Ë∑Ø/ÂëºÂê∏Âô®/ÁáíÁáôÂÇ∑/‰∏âÁ¥öÂÇ∑Âè£ÔΩúËá≥Â∞ë1Ë≠∑ÁêÜ+2ÁÖßÊúç' },
            ]},
            { category: 'Á§æÂçÄÂºèÊúçÂãô', items: [
                { code: 'BD01', name: 'Á§æÂçÄÂºèÂçîÂä©Ê≤êÊµ¥', price: 200, 
                  note: 'ÊñºÊó•ÁÖß‰∏≠ÂøÉÊàñÊâòÈ°ßÂÆ∂Â∫≠Êµ¥ÈñìÂü∑Ë°å' },
                { code: 'BD02', name: 'Á§æÂçÄÂºèÊôöÈ§ê', price: 150, 
                  note: 'ÊñºÊó•ÁÖß‰∏≠ÂøÉÊàñÊâòÈ°ßÂÆ∂Â∫≠Âü∑Ë°å' },
                { code: 'BD03', name: 'Á§æÂçÄÂºèÊúçÂãô‰∫§ÈÄöÊé•ÈÄÅ', price: 100, unit: '/Ë∂ü', 
                  note: '‚úìÂ§ñÁ±çÂèØÁî®ÔΩú10kmÂÖßÔΩúÈúÄËÅ∑Ê•≠ÈßïÁÖß' },
            ]},
            { category: 'BBÁ¢º Êó•ÈñìÁÖßÈ°ßÔºà‰æùCMSÁ≠âÁ¥öÔºâ', isDynamic: true, dynamicType: 'BB', items: [
                { code: 'BB-full', name: 'Êó•ÈñìÁÖßÈ°ß-ÂÖ®Êó•', priceKey: 'full', unit: '/Êó•',
                  note: '‰∫§ÈÄöÊé•ÈÄÅÂè¶Ë®à' },
                { code: 'BB-half', name: 'Êó•ÈñìÁÖßÈ°ß-ÂçäÊó•', priceKey: 'half', unit: '/ÂçäÊó•', 
                  note: 'ÂêåÊó•‰∏çÂæóÁî≥Ë´ã‰∫åÊ¨°ÔΩú‰∫§ÈÄöÊé•ÈÄÅÂè¶Ë®à' },
            ]},
            { category: 'BCÁ¢º ÂÆ∂Â∫≠ÊâòÈ°ßÔºà‰æùCMSÁ≠âÁ¥öÔºâ', isDynamic: true, dynamicType: 'BC', items: [
                { code: 'BC-full', name: 'ÂÆ∂Â∫≠ÊâòÈ°ß-ÂÖ®Êó•', priceKey: 'full', unit: '/Êó•',
                  note: '‰∫§ÈÄöÊé•ÈÄÅÂè¶Ë®à' },
                { code: 'BC-half', name: 'ÂÆ∂Â∫≠ÊâòÈ°ß-ÂçäÊó•', priceKey: 'half', unit: '/ÂçäÊó•', 
                  note: 'ÂêåÊó•‰∏çÂæóÁî≥Ë´ã‰∫åÊ¨°ÔΩú‰∫§ÈÄöÊé•ÈÄÅÂè¶Ë®à' },
            ]},
        ];

        // CÁ¢ºÂ∞àÊ•≠ÊúçÂãô
        const C_SERVICES = [
            { category: 'CÁ¢º Â∞àÊ•≠ÊúçÂãôÔºàÊï¥ÁµÑË®àÂÉπÔºâ', items: [
                { code: 'CA07', name: 'IADLs/ADLsÂæ©ËÉΩÁÖßË≠∑', price: 4500, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´3Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞Ôºâ' },
                { code: 'CA08', name: 'ÂÄãÂà•ÂåñÊúçÂãôË®àÁï´(ISP)', price: 6000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´4Ê¨°Êé™ÊñΩÔΩú‚ö†ÈôêË∫´ÂøÉÈöúÁ§ô(ÊÖ¢ÊÄßÁ≤æÁ•û/Ëá™Èñâ/Êô∫Èöú/Â§±Êô∫)Êàñ50Ê≠≤‰ª•‰∏äÂ§±Êô∫' },
                { code: 'CB01', name: 'ÁáüÈ§äÁÖßË≠∑', price: 4000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´4Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞Ôºâ' },
                { code: 'CB02', name: 'ÈÄ≤È£üËàáÂêûÂö•ÁÖßË≠∑', price: 9000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´6Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞Ôºâ' },
                { code: 'CB03', name: 'Âõ∞ÊìæË°åÁÇ∫ÁÖßË≠∑', price: 4500, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´3Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞Ôºâ' },
                { code: 'CB04', name: 'Ëá•Â∫äÊàñÈï∑ÊúüÊ¥ªÂãïÂèóÈôêÁÖßË≠∑', price: 9000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´6Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞Ôºâ' },
                { code: 'CC01', name: 'Â±ÖÂÆ∂Áí∞Â¢ÉÂÆâÂÖ®ÊàñÁÑ°ÈöúÁ§ôÁ©∫ÈñìË¶èÂäÉ', price: 2000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´2Ê¨°Êé™ÊñΩÔºàÂê´Ë©ï‰º∞ÔºâÔΩúËºîÂÖ∑Êàñ‰øÆÁπï‰æùE/FÁ¢ºÂè¶Ë®à' },
                { code: 'CD02', name: 'Â±ÖÂÆ∂Ë≠∑ÁêÜÊåáÂ∞éËàáË´ÆË©¢', price: 6000, unit: '/ÁµÑ', maxQty: 1,
                  note: 'Âê´3Ê¨°Êé™ÊñΩ+1Ê¨°Ë©ïÂÄºÔΩúÈúÄÂÆåÊàêË°õÁ¶èÈÉ®Ë™çÂèØË®ìÁ∑¥' },
            ]},
        ];

        // GÁ¢ºÂñòÊÅØÊúçÂãô
        const G_SERVICES = [
            { category: 'GÁ¢º ÂñòÊÅØÊúçÂãôÔºàÂπ¥È°çÂ∫¶Ôºâ', items: [
                { code: 'GA03', name: 'Êó•ÈñìÁÖßÈ°ß‰∏≠ÂøÉÂñòÊÅØ-ÂÖ®Êó•', price: 1250, unit: '/Êó•',
                  note: 'Âê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'GA04', name: 'Êó•ÈñìÁÖßÈ°ß‰∏≠ÂøÉÂñòÊÅØ-ÂçäÊó•', price: 625, unit: '/ÂçäÊó•',
                  note: 'Âê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'GA05', name: 'Ê©üÊßã‰ΩèÂÆøÂºèÂñòÊÅØ', price: 2310, unit: '/Êó•',
                  note: '24Â∞èÊôÇÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰ΩçÔΩúÂê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'GA06', name: 'Â∞èË¶èÊ®°Â§öÊ©üËÉΩÂ§úÈñìÂñòÊÅØ', price: 2000, unit: '/Â§ú',
                  note: '18:00-ÁøåÊó•08:00ÔΩúÂê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'GA07', name: 'Â∑∑ÂºÑÈï∑ÁÖßÁ´ôÂñòÊÅØ', price: 170, unit: '/hr' },
                { code: 'GA09', name: 'Â±ÖÂÆ∂ÂñòÊÅØ', price: 770, unit: '/2hr',
                  note: '2Â∞èÊôÇÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰ΩçÔΩúÊó•Èôê5ÁµÑ(10hr)' },
            ]},
        ];

        // SCÁ¢ºÁü≠ÁÖßÊúçÂãôÔºàÂÉÖÈÅ©Áî®ËÅòÂÉ±Â§ñÁ±çÁúãË≠∑Â∑•Ôºâ
        const SC_SERVICES = [
            { category: 'SCÁ¢º Áü≠ÁÖßÊúçÂãôÔºàÂπ¥È°çÂ∫¶Ôºâ', items: [
                { code: 'SC03', name: 'Êó•ÁÖß‰∏≠ÂøÉÂñòÊÅØÊúçÂãô-ÂÖ®Êó•', price: 1250, unit: '/Êó•',
                  note: 'Âê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'SC04', name: 'Êó•ÁÖß‰∏≠ÂøÉÂñòÊÅØÊúçÂãô-ÂçäÊó•', price: 625, unit: '/ÂçäÊó•',
                  note: 'Âê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'SC05', name: 'Ê©üÊßã‰ΩèÂÆøÂºèÂñòÊÅØÊúçÂãô', price: 2310, unit: '/Êó•',
                  note: '24Â∞èÊôÇÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰ΩçÔΩúÂê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'SC06', name: 'Â∞èË¶èÊ®°Â§öÊ©üËÉΩ-Â§úÈñìÂñòÊÅØ', price: 2000, unit: '/Â§ú',
                  note: '18:00-ÁøåÊó•08:00ÔΩúÂê´‰∫§ÈÄöÊé•ÈÄÅ' },
                { code: 'SC07', name: 'Â∑∑ÂºÑÈï∑ÁÖßÁ´ôÂñòÊÅØÊúçÂãô', price: 170, unit: '/hr',
                  note: '‰ª•ÊØèÂ∞èÊôÇÁÇ∫Áµ¶‰ªòÂñÆ‰Ωç' },
                { code: 'SC09', name: 'Â±ÖÂÆ∂ÂñòÊÅØÊúçÂãô', price: 770, unit: '/2hr',
                  note: '2Â∞èÊôÇÁÇ∫‰∏ÄÁµ¶‰ªòÂñÆ‰ΩçÔΩúÊó•Èôê5ÁµÑ(10hr)' },
            ]},
        ];

        // ===== ÁãÄÊÖã =====
        let state = {
            cmsLevel: null,
            identity: null,
            hasForeign: false,
            quantities: {},
            expanded: {},
            activeTab: 'bc',
            calcExpanded: { bc: true, g: true, sc: true }
        };

        [...B_SERVICES, ...C_SERVICES, ...G_SERVICES, ...SC_SERVICES].forEach(cat => {
            state.expanded[cat.category] = false;
        });

        // ===== Â∑•ÂÖ∑ÂáΩÊï∏ =====
        const $ = id => document.getElementById(id);

        function showToast(msg) {
            const toast = $('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function getCodeType(code) {
            if (code.startsWith('G')) return 'g';
            return 'bc';
        }

        function isForeignAllowed(code) {
            if (code.startsWith('C')) return true;
            if (code.startsWith('G')) return true;
            return FOREIGN_B_ALLOWED.includes(code);
        }

        function getDynamicPrice(code, cmsLevel) {
            if (!cmsLevel) return 0;
            if (code === 'BB-full') return BB_PRICES[cmsLevel].full;
            if (code === 'BB-half') return BB_PRICES[cmsLevel].half;
            if (code === 'BC-full') return BC_PRICES[cmsLevel].full;
            if (code === 'BC-half') return BC_PRICES[cmsLevel].half;
            return 0;
        }

        function getItemPrice(item) {
            if (item.priceKey) {
                return getDynamicPrice(item.code, state.cmsLevel);
            }
            return item.price;
        }

        function getAllBcServices() {
            const result = [];
            [...B_SERVICES, ...C_SERVICES].forEach(cat => {
                cat.items.forEach(item => {
                    result.push({ ...item, price: getItemPrice(item) });
                });
            });
            return result;
        }

        function getAllGServices() {
            return G_SERVICES.flatMap(c => c.items);
        }

        function getAllScServices() {
            return SC_SERVICES.flatMap(c => c.items);
        }

        function updateStepIndicators() {
            const step1 = $('step1');
            const step2 = $('step2');
            const step3 = $('step3');

            // Step 1
            if (state.cmsLevel) {
                step1.className = 'step done';
                step1.textContent = '‚úì';
            } else {
                step1.className = 'step active';
                step1.textContent = 'Step 1';
            }

            // Step 2
            if (state.identity) {
                step2.className = 'step done';
                step2.textContent = '‚úì';
            } else if (state.cmsLevel) {
                step2.className = 'step active';
                step2.textContent = 'Step 2';
            } else {
                step2.className = 'step';
                step2.textContent = 'Step 2';
            }

            // Step 3
            if (state.cmsLevel && state.identity) {
                step3.className = 'step active';
                step3.textContent = 'Step 3';
            } else {
                step3.className = 'step';
                step3.textContent = 'Step 3';
            }

            // Âç°ÁâáÈéñÂÆöÁãÄÊÖã
            $('identityCard').classList.toggle('locked', !state.cmsLevel);
            $('serviceCard').classList.toggle('locked', !state.cmsLevel || !state.identity);

            // Ë§áË£Ω/ÂåØÂá∫ÊåâÈàï
            $('copyBtn').disabled = !state.cmsLevel || !state.identity;
            $('exportBtn').disabled = !state.cmsLevel || !state.identity;
        }

        function updateSelectionSummary() {
            const summary = $('selectionSummary');
            if (!state.cmsLevel) {
                summary.innerHTML = '';
                return;
            }

            let html = '<span class="summary-tag">CMS ' + state.cmsLevel + 'Á¥ö</span>';
            
            let quotaBc = CMS_BC_QUOTA[state.cmsLevel];
            if (state.hasForeign) quotaBc = Math.floor(quotaBc * 0.3);
            
            html += '<span class="summary-tag">B/CÈ°çÂ∫¶ $' + quotaBc.toLocaleString() + '</span>';
            html += '<span class="summary-tag">GÈ°çÂ∫¶ $' + CMS_G_QUOTA[state.cmsLevel].toLocaleString() + '</span>';
            
            if (state.hasForeign) {
                html += '<span class="summary-tag" style="color:#22d3ee;">SCÈ°çÂ∫¶ $' + CMS_SC_QUOTA[state.cmsLevel].toLocaleString() + '</span>';
            }
            
            if (state.identity) {
                html += '<span class="summary-tag">' + IDENTITY_NAMES[state.identity] + '</span>';
            }
            
            if (state.hasForeign) {
                html += '<span class="summary-tag orange">Â§ñÁ±çÁúãË≠∑</span>';
            }

            summary.innerHTML = html;
        }

        // ===== Ê∏≤Êüì =====
        
        // ÂÖ®Â±ÄÈÅ∏ÊìáÂáΩÊï∏Ôºà‰æõ onclick ‰ΩøÁî®Ôºâ
        function selectCMS(level) {
            state.cmsLevel = parseInt(level);
            updateCMSButtons();
            updateIdentityButtons();
            updateStepIndicators();
            updateSelectionSummary();
            if (state.identity) {
                renderAllServices();
                calculate();
            }
        }
        
        function selectIdentity(key) {
            state.identity = key;
            updateIdentityButtons();
            updateStepIndicators();
            updateSelectionSummary();
            renderAllServices();
            calculate();
        }
        
        function updateCMSButtons() {
            document.querySelectorAll('#cmsGrid .selector-btn').forEach(btn => {
                const level = parseInt(btn.getAttribute('data-level'));
                btn.classList.toggle('active', state.cmsLevel === level);
            });
        }
        
        function updateIdentityButtons() {
            document.querySelectorAll('#identityGrid .identity-btn').forEach(btn => {
                const identity = btn.getAttribute('data-identity');
                btn.classList.toggle('active', state.identity === identity);
            });
        }
        
        // ‰øùÁïôÂéüÂáΩÊï∏ÂêçÁ®±‰ª•ÂÖºÂÆπÂÖ∂‰ªñË™øÁî®
        function renderCMS() {
            updateCMSButtons();
        }

        function renderIdentity() {
            updateIdentityButtons();
        }

        function renderServiceList(services, containerId, headerClass) {
            const container = $(containerId);
            container.innerHTML = '';

            services.forEach(category => {
                const items = category.items;

                if (items.length === 0) return;

                const section = document.createElement('div');
                section.className = 'service-section';
                const isOpen = state.expanded[category.category];

                section.innerHTML =
                    '<div class="collapse-header" data-cat="' + category.category + '">' +
                    '<h3 class="' + headerClass + '">' + category.category + '</h3>' +
                    '<span class="collapse-icon ' + (isOpen ? 'open' : '') + '">‚ñº</span>' +
                    '</div>' +
                    '<div class="collapse-content ' + (isOpen ? 'open' : '') + '">' +
                    '<div class="service-list"></div>' +
                    '</div>';

                const list = section.querySelector('.service-list');
                items.forEach(item => {
                    const codeType = getCodeType(item.code);
                    const isDisabled = state.hasForeign && codeType === 'bc' && !isForeignAllowed(item.code);
                    const qty = state.quantities[item.code] || 0;
                    const maxQty = item.maxQty || 999;
                    
                    const price = getItemPrice(item);

                    const div = document.createElement('div');
                    let itemClass = '';
                    let codeClass = '';
                    
                    if (item.code.startsWith('C')) {
                        itemClass = 'c-item';
                        codeClass = 'c-code';
                    } else if (item.code.startsWith('BB')) {
                        itemClass = 'bb-item';
                        codeClass = 'bb-code';
                    } else if (item.code.startsWith('BC')) {
                        itemClass = 'bc-item';
                        codeClass = 'bc-code';
                    }

                    div.className = 'service-item ' + itemClass + (isDisabled ? ' disabled' : '');
                    
                    const showPlus5 = maxQty > 1;
                    
                    div.innerHTML =
                        '<div class="service-info">' +
                        '<div class="service-name">' +
                        '<span class="service-code ' + codeClass + '">' + item.code + '</span>' + item.name +
                        '</div>' +
                        '<div class="service-price">$' + price.toLocaleString() + (item.unit || '') + '</div>' +
                        (item.note ? '<div class="service-note">' + item.note + '</div>' : '') +
                        '</div>' +
                        '<div class="service-controls">' +
                        '<button class="qty-btn minus" data-code="' + item.code + '" ' + (isDisabled ? 'disabled' : '') + '>‚àí</button>' +
                        '<span class="qty-display ' + (qty > 0 ? 'has-value' : '') + '">' + qty + '</span>' +
                        '<button class="qty-btn plus" data-code="' + item.code + '" data-max="' + maxQty + '" ' + (isDisabled || qty >= maxQty ? 'disabled' : '') + '>+</button>' +
                        (showPlus5 ? '<button class="qty-btn plus5" data-code="' + item.code + '" data-max="' + maxQty + '" ' + (isDisabled || qty >= maxQty ? 'disabled' : '') + '>+5</button>' : '') +
                        '</div>';
                    list.appendChild(div);
                });

                section.querySelector('.collapse-header').onclick = function () {
                    const cat = this.getAttribute('data-cat');
                    state.expanded[cat] = !state.expanded[cat];
                    this.nextElementSibling.classList.toggle('open');
                    this.querySelector('.collapse-icon').classList.toggle('open');
                };

                container.appendChild(section);
            });

            container.querySelectorAll('.qty-btn').forEach(btn => {
                btn.onclick = function () {
                    const code = this.getAttribute('data-code');
                    const maxQty = parseInt(this.getAttribute('data-max')) || 999;
                    let delta = 0;
                    if (this.classList.contains('plus5')) delta = 5;
                    else if (this.classList.contains('plus')) delta = 1;
                    else if (this.classList.contains('minus')) delta = -1;
                    
                    const current = state.quantities[code] || 0;
                    let next = Math.max(0, Math.min(maxQty, current + delta));

                    if (next === 0) delete state.quantities[code];
                    else state.quantities[code] = next;

                    renderAllServices();
                    calculate();
                };
            });
        }

        function renderAllServices() {
            renderServiceList([...B_SERVICES, ...C_SERVICES], 'bcContainer', 'bc-header');
            renderServiceList(G_SERVICES, 'gContainer', 'g-header');
            renderScServices();
        }
        
        // SCÁ¢ºÂñÆÁç®Ê∏≤ÊüìÔºàÂ∏∂ÈéñÂÆöÈÇèËºØÔºâ
        function renderScServices() {
            const container = $('scContainer');
            if (!container) return;
            
            // Êõ¥Êñ∞ÈéñÂÆöÁãÄÊÖã
            container.classList.toggle('sc-locked', !state.hasForeign);
            
            if (!state.hasForeign) {
                container.innerHTML = 
                    '<div class="sc-lock-overlay">' +
                    '<span class="lock-icon">üîí</span>' +
                    '<span class="lock-text">ÂÉÖÈÅ©Áî®ËÅòÂÉ±Â§ñÁ±çÁúãË≠∑Â∑•ÂÆ∂Â∫≠</span>' +
                    '</div>' +
                    '<div class="sc-placeholder">' +
                    '<div class="collapse-header">' +
                    '<h3 class="sc-header">SCÁ¢º Áü≠ÁÖßÊúçÂãôÔºàÂπ¥È°çÂ∫¶Ôºâ</h3>' +
                    '<span class="collapse-icon">‚ñº</span>' +
                    '</div>' +
                    '</div>';
                return;
            }
            
            // ÊúâÂ§ñÁ±çÁúãË≠∑Â∑•ÊôÇÊ≠£Â∏∏Ê∏≤Êüì
            container.innerHTML = '';
            SC_SERVICES.forEach(category => {
                const items = category.items;
                if (items.length === 0) return;

                const section = document.createElement('div');
                section.className = 'service-section';
                const isOpen = state.expanded[category.category];

                section.innerHTML =
                    '<div class="collapse-header" data-cat="' + category.category + '">' +
                    '<h3 class="sc-header">' + category.category + '</h3>' +
                    '<span class="collapse-icon ' + (isOpen ? 'open' : '') + '">‚ñº</span>' +
                    '</div>' +
                    '<div class="collapse-content ' + (isOpen ? 'open' : '') + '">' +
                    '<div class="service-list"></div>' +
                    '</div>';

                const list = section.querySelector('.service-list');
                items.forEach(item => {
                    const qty = state.quantities[item.code] || 0;
                    const maxQty = item.maxQty || 999;
                    const price = item.price;

                    const div = document.createElement('div');
                    div.className = 'service-item sc-item';
                    
                    const showPlus5 = maxQty > 1;
                    
                    div.innerHTML =
                        '<div class="service-info">' +
                        '<div class="service-name">' +
                        '<span class="service-code sc-code">' + item.code + '</span>' + item.name +
                        '</div>' +
                        '<div class="service-price">$' + price.toLocaleString() + (item.unit || '') + '</div>' +
                        (item.note ? '<div class="service-note">' + item.note + '</div>' : '') +
                        '</div>' +
                        '<div class="service-controls">' +
                        '<button class="qty-btn minus" data-code="' + item.code + '">‚àí</button>' +
                        '<span class="qty-display ' + (qty > 0 ? 'has-value' : '') + '">' + qty + '</span>' +
                        '<button class="qty-btn plus" data-code="' + item.code + '" data-max="' + maxQty + '" ' + (qty >= maxQty ? 'disabled' : '') + '>+</button>' +
                        (showPlus5 ? '<button class="qty-btn plus5" data-code="' + item.code + '" data-max="' + maxQty + '" ' + (qty >= maxQty ? 'disabled' : '') + '>+5</button>' : '') +
                        '</div>';

                    list.appendChild(div);
                });

                // Ë®≠ÂÆöÂ±ïÈñã/Êî∂Âêà
                section.querySelector('.collapse-header').onclick = function () {
                    const cat = this.getAttribute('data-cat');
                    state.expanded[cat] = !state.expanded[cat];
                    this.querySelector('.collapse-icon').classList.toggle('open');
                    this.nextElementSibling.classList.toggle('open');
                };

                // Êï∏ÈáèÊåâÈàï
                section.querySelectorAll('.qty-btn').forEach(btn => {
                    btn.onclick = function () {
                        if (this.disabled) return;
                        const code = this.getAttribute('data-code');
                        const max = parseInt(this.getAttribute('data-max')) || 999;
                        let delta = 0;
                        if (this.classList.contains('minus')) delta = -1;
                        else if (this.classList.contains('plus')) delta = 1;
                        else if (this.classList.contains('plus5')) delta = 5;

                        state.quantities[code] = Math.max(0, Math.min(max, (state.quantities[code] || 0) + delta));
                        renderScServices();
                        calculate();
                    };
                });

                container.appendChild(section);
            });
        }

        // ===== Ë®àÁÆó =====
        function calculate() {
            if (!state.cmsLevel || !state.identity) return;

            const bcItems = getAllBcServices();
            const gItems = getAllGServices();
            const scItems = getAllScServices();
            const rateBc = COPAY_RATES.bc[state.identity] / 100;
            const rateG = COPAY_RATES.g[state.identity] / 100;
            const rateSc = COPAY_RATES.sc[state.identity] / 100;

            let bcTotal = 0;
            const bcSelected = [];
            
            Object.entries(state.quantities).forEach(([code, qty]) => {
                if (qty <= 0) return;
                const item = bcItems.find(s => s.code === code);
                if (!item) return;
                if (item.price === 0) return;
                if (state.hasForeign && !isForeignAllowed(code)) return;

                const subtotal = item.price * qty;
                const copayUnit = Math.floor(item.price * rateBc);
                const copayTotal = Math.floor(subtotal * rateBc);
                bcTotal += subtotal;
                bcSelected.push({ ...item, qty, subtotal, copayUnit, copayTotal });
            });

            let gTotal = 0;
            const gSelected = [];

            Object.entries(state.quantities).forEach(([code, qty]) => {
                if (qty <= 0) return;
                const item = gItems.find(s => s.code === code);
                if (!item) return;

                const subtotal = item.price * qty;
                const copayUnit = Math.floor(item.price * rateG);
                const copayTotal = Math.floor(subtotal * rateG);
                gTotal += subtotal;
                gSelected.push({ ...item, qty, subtotal, copayUnit, copayTotal });
            });

            // SCÁ¢ºË®àÁÆóÔºàÂÉÖÂú®ÊúâÂ§ñÁ±çÁúãË≠∑Â∑•ÊôÇÔºâ
            let scTotal = 0;
            const scSelected = [];

            if (state.hasForeign) {
                Object.entries(state.quantities).forEach(([code, qty]) => {
                    if (qty <= 0) return;
                    const item = scItems.find(s => s.code === code);
                    if (!item) return;

                    const subtotal = item.price * qty;
                    const copayUnit = Math.floor(item.price * rateSc);
                    const copayTotal = Math.floor(subtotal * rateSc);
                    scTotal += subtotal;
                    scSelected.push({ ...item, qty, subtotal, copayUnit, copayTotal });
                });
            }

            let quotaBc = CMS_BC_QUOTA[state.cmsLevel];
            if (state.hasForeign) quotaBc = Math.floor(quotaBc * 0.3);
            const quotaG = CMS_G_QUOTA[state.cmsLevel];
            const quotaSc = state.hasForeign ? CMS_SC_QUOTA[state.cmsLevel] : 0;

            renderBcCalcDetail(bcSelected, bcTotal, quotaBc, rateBc);
            renderGCalcDetail(gSelected, gTotal, quotaG, rateG);
            renderScCalcDetail(scSelected, scTotal, quotaSc, rateSc);
            renderGrandTotal(bcTotal, gTotal, scTotal, quotaBc, quotaG, quotaSc, rateBc, rateG, rateSc);
        }

        function renderBcCalcDetail(selected, total, quota, rate) {
            const detail = $('bcCalcDetail');
            const content = $('bcCalcContent');
            const subtotalEl = $('bcSubtotal');

            if (selected.length === 0) {
                detail.classList.add('hidden');
                return;
            }

            detail.classList.remove('hidden');
            
            content.innerHTML = selected.map(item => 
                '<div class="calc-item">' +
                '<div class="calc-item-header">' +
                '<span class="calc-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>' +
                '<span class="calc-item-qty">√ó ' + item.qty + '</span>' +
                '</div>' +
                '<div class="calc-item-rows">' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">ÂñÆÂÉπ</span>' +
                '<span class="calc-row-value">$' + item.price.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayUnit.toLocaleString() + '</span></span>' +
                '</div>' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">Â∞èË®à (' + item.qty + 'ÁµÑ)</span>' +
                '<span class="calc-row-value">$' + item.subtotal.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayTotal.toLocaleString() + '</span></span>' +
                '</div>' +
                '</div>' +
                '</div>'
            ).join('');

            const totalCopay = total <= quota 
                ? Math.floor(total * rate) 
                : Math.floor(quota * rate) + (total - quota);
            const copayLabel = total <= quota 
                ? 'Ëá™Ë≤† $' + totalCopay.toLocaleString()
                : 'Ëá™Ë≤† $' + totalCopay.toLocaleString() + ' (Âê´Ë∂ÖÈ°ç)';
            subtotalEl.innerHTML = 
                '<span class="calc-subtotal-label">B/CÁ¢ºÂêàË®à</span>' +
                '<span class="calc-subtotal-value">' +
                '<span class="amount">$' + total.toLocaleString() + '</span>' +
                '<span class="copay">' + copayLabel + '</span>' +
                '</span>';
        }

        function renderGCalcDetail(selected, total, quota, rate) {
            const detail = $('gCalcDetail');
            const content = $('gCalcContent');
            const subtotalEl = $('gSubtotal');

            if (selected.length === 0) {
                detail.classList.add('hidden');
                return;
            }

            detail.classList.remove('hidden');
            
            content.innerHTML = selected.map(item => 
                '<div class="calc-item">' +
                '<div class="calc-item-header">' +
                '<span class="calc-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>' +
                '<span class="calc-item-qty">√ó ' + item.qty + '</span>' +
                '</div>' +
                '<div class="calc-item-rows">' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">ÂñÆÂÉπ</span>' +
                '<span class="calc-row-value">$' + item.price.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayUnit.toLocaleString() + '</span></span>' +
                '</div>' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">Â∞èË®à (' + item.qty + 'ÁµÑ)</span>' +
                '<span class="calc-row-value">$' + item.subtotal.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayTotal.toLocaleString() + '</span></span>' +
                '</div>' +
                '</div>' +
                '</div>'
            ).join('');

            const totalCopay = total <= quota 
                ? Math.floor(total * rate) 
                : Math.floor(quota * rate) + (total - quota);
            const copayLabel = total <= quota 
                ? 'Ëá™Ë≤† $' + totalCopay.toLocaleString()
                : 'Ëá™Ë≤† $' + totalCopay.toLocaleString() + ' (Âê´Ë∂ÖÈ°ç)';
            subtotalEl.innerHTML = 
                '<span class="calc-subtotal-label">GÁ¢ºÂêàË®à</span>' +
                '<span class="calc-subtotal-value">' +
                '<span class="amount">$' + total.toLocaleString() + '</span>' +
                '<span class="copay">' + copayLabel + '</span>' +
                '</span>';
        }

        function renderScCalcDetail(selected, total, quota, rate) {
            const detail = $('scCalcDetail');
            const content = $('scCalcContent');
            const subtotalEl = $('scSubtotal');

            if (!detail) return;

            if (selected.length === 0 || !state.hasForeign) {
                detail.classList.add('hidden');
                return;
            }

            detail.classList.remove('hidden');
            
            content.innerHTML = selected.map(item => 
                '<div class="calc-item">' +
                '<div class="calc-item-header">' +
                '<span class="calc-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>' +
                '<span class="calc-item-qty">√ó ' + item.qty + '</span>' +
                '</div>' +
                '<div class="calc-item-rows">' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">ÂñÆÂÉπ</span>' +
                '<span class="calc-row-value">$' + item.price.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayUnit.toLocaleString() + '</span></span>' +
                '</div>' +
                '<div class="calc-row">' +
                '<span class="calc-row-label">Â∞èË®à (' + item.qty + 'ÁµÑ)</span>' +
                '<span class="calc-row-value">$' + item.subtotal.toLocaleString() + '<span class="copay">Ëá™Ë≤† $' + item.copayTotal.toLocaleString() + '</span></span>' +
                '</div>' +
                '</div>' +
                '</div>'
            ).join('');

            const totalCopay = total <= quota 
                ? Math.floor(total * rate) 
                : Math.floor(quota * rate) + (total - quota);
            const copayLabel = total <= quota 
                ? 'Ëá™Ë≤† $' + totalCopay.toLocaleString()
                : 'Ëá™Ë≤† $' + totalCopay.toLocaleString() + ' (Âê´Ë∂ÖÈ°ç)';
            subtotalEl.innerHTML = 
                '<span class="calc-subtotal-label">SCÁ¢ºÂêàË®à</span>' +
                '<span class="calc-subtotal-value">' +
                '<span class="amount">$' + total.toLocaleString() + '</span>' +
                '<span class="copay">' + copayLabel + '</span>' +
                '</span>';
        }

        function renderGrandTotal(bcTotal, gTotal, scTotal, quotaBc, quotaG, quotaSc, rateBc, rateG, rateSc) {
            const content = $('grandTotalContent');
            
            // B/CÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
            let bcCopay;
            let bcCopayLabel;
            if (bcTotal <= quotaBc) {
                bcCopay = Math.floor(bcTotal * rateBc);
                bcCopayLabel = 'B/CÁ¢º ÈÉ®ÂàÜË≤†Êìî (' + (rateBc * 100) + '%)';
            } else {
                const inQuota = Math.floor(quotaBc * rateBc);
                const overQuota = bcTotal - quotaBc;
                bcCopay = inQuota + overQuota;
                bcCopayLabel = 'B/CÁ¢º ÈÉ®ÂàÜË≤†Êìî (Âê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉ)';
            }
            
            // GÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
            let gCopay;
            let gCopayLabel;
            if (gTotal <= quotaG) {
                gCopay = Math.floor(gTotal * rateG);
                gCopayLabel = 'GÁ¢º ÈÉ®ÂàÜË≤†Êìî (' + (rateG * 100) + '%)';
            } else {
                const inQuota = Math.floor(quotaG * rateG);
                const overQuota = gTotal - quotaG;
                gCopay = inQuota + overQuota;
                gCopayLabel = 'GÁ¢º ÈÉ®ÂàÜË≤†Êìî (Âê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉ)';
            }
            
            // SCÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
            let scCopay = 0;
            let scCopayLabel = '';
            if (state.hasForeign && quotaSc > 0) {
                if (scTotal <= quotaSc) {
                    scCopay = Math.floor(scTotal * rateSc);
                    scCopayLabel = 'SCÁ¢º ÈÉ®ÂàÜË≤†Êìî (' + (rateSc * 100) + '%)';
                } else {
                    const inQuota = Math.floor(quotaSc * rateSc);
                    const overQuota = scTotal - quotaSc;
                    scCopay = inQuota + overQuota;
                    scCopayLabel = 'SCÁ¢º ÈÉ®ÂàÜË≤†Êìî (Âê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉ)';
                }
            }
            
            const dCopay = Math.floor(D_QUOTA * COPAY_RATES.d[state.identity] / 100);

            const bcRemain = quotaBc - bcTotal;
            const gRemain = quotaG - gTotal;
            const scRemain = quotaSc - scTotal;

            let html = 
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">B/CÁ¢º ÊúàÈ°çÂ∫¶' + (state.hasForeign ? '(Â§ñÁ±ç30%)' : '') + '</span>' +
                '<span class="grand-total-value">' + quotaBc.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">B/CÁ¢º Â∑≤‰ΩøÁî®</span>' +
                '<span class="grand-total-value total">' + bcTotal.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">B/CÁ¢º Ââ©È§ò</span>' +
                '<span class="grand-total-value ' + (bcRemain >= 0 ? 'remain' : 'negative') + '">' + bcRemain.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">' + bcCopayLabel + '</span>' +
                '<span class="grand-total-value copay">' + bcCopay.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +

                '<div class="grand-total-row" style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">' +
                '<span class="grand-total-label">DÁ¢º ÊúàÈ°çÂ∫¶</span>' +
                '<span class="grand-total-value">' + D_QUOTA.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">DÁ¢º ÈÉ®ÂàÜË≤†Êìî (' + COPAY_RATES.d[state.identity] + '%)</span>' +
                '<span class="grand-total-value copay">' + dCopay.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +

                '<div class="grand-total-row" style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">' +
                '<span class="grand-total-label">GÁ¢º Âπ¥È°çÂ∫¶</span>' +
                '<span class="grand-total-value">' + quotaG.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">GÁ¢º Â∑≤‰ΩøÁî®</span>' +
                '<span class="grand-total-value total">' + gTotal.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">GÁ¢º Ââ©È§ò</span>' +
                '<span class="grand-total-value ' + (gRemain >= 0 ? 'remain' : 'negative') + '">' + gRemain.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>' +
                '<div class="grand-total-row">' +
                '<span class="grand-total-label">' + gCopayLabel + '</span>' +
                '<span class="grand-total-value copay">' + gCopay.toLocaleString() + ' ÂÖÉ</span>' +
                '</div>';

            // SCÁ¢ºÂçÄÂ°äÔºàÂÉÖÂú®ÊúâÂ§ñÁ±çÁúãË≠∑Â∑•ÊôÇÈ°ØÁ§∫Ôºâ
            if (state.hasForeign) {
                html +=
                    '<div class="grand-total-row" style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">' +
                    '<span class="grand-total-label" style="color:#22d3ee;">SCÁ¢º Âπ¥È°çÂ∫¶ÔºàÁü≠ÁÖßÔºâ</span>' +
                    '<span class="grand-total-value">' + quotaSc.toLocaleString() + ' ÂÖÉ</span>' +
                    '</div>' +
                    '<div class="grand-total-row">' +
                    '<span class="grand-total-label">SCÁ¢º Â∑≤‰ΩøÁî®</span>' +
                    '<span class="grand-total-value total">' + scTotal.toLocaleString() + ' ÂÖÉ</span>' +
                    '</div>' +
                    '<div class="grand-total-row">' +
                    '<span class="grand-total-label">SCÁ¢º Ââ©È§ò</span>' +
                    '<span class="grand-total-value ' + (scRemain >= 0 ? 'remain' : 'negative') + '">' + scRemain.toLocaleString() + ' ÂÖÉ</span>' +
                    '</div>' +
                    '<div class="grand-total-row">' +
                    '<span class="grand-total-label">' + scCopayLabel + '</span>' +
                    '<span class="grand-total-value copay">' + scCopay.toLocaleString() + ' ÂÖÉ</span>' +
                    '</div>';
            }

            html +=
                '<div class="grand-total-row main">' +
                '<span class="grand-total-label">Á∏ΩÈÉ®ÂàÜË≤†Êìî</span>' +
                '<span class="grand-total-value copay">' + (bcCopay + dCopay + gCopay + scCopay).toLocaleString() + ' ÂÖÉ</span>' +
                '</div>';
            
            content.innerHTML = html;
        }

        // ===== TabÂàáÊèõ =====
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = function () {
                    const tab = this.getAttribute('data-tab');
                    state.activeTab = tab;

                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    $('bcContainer').classList.toggle('hidden', tab !== 'bc');
                    $('gContainer').classList.toggle('hidden', tab !== 'g');
                    $('scContainer').classList.toggle('hidden', tab !== 'g');
                };
            });
        }

        function setupCalcToggles() {
            $('bcCalcToggle').onclick = function() {
                state.calcExpanded.bc = !state.calcExpanded.bc;
                $('bcCalcContent').classList.toggle('open');
                this.querySelector('.calc-detail-toggle').classList.toggle('open');
            };

            $('gCalcToggle').onclick = function() {
                state.calcExpanded.g = !state.calcExpanded.g;
                $('gCalcContent').classList.toggle('open');
                this.querySelector('.calc-detail-toggle').classList.toggle('open');
            };

            $('scCalcToggle').onclick = function() {
                state.calcExpanded.sc = !state.calcExpanded.sc;
                $('scCalcContent').classList.toggle('open');
                this.querySelector('.calc-detail-toggle').classList.toggle('open');
            };
        }

        // ===== ÂàùÂßãÂåñ =====
        function init() {
            renderCMS();
            renderIdentity();
            updateStepIndicators();
            setupTabs();
            setupCalcToggles();

            $('foreignToggle').onclick = function () {
                state.hasForeign = !state.hasForeign;
                this.classList.toggle('active');
                $('foreignNote').style.display = state.hasForeign ? 'block' : 'none';
                updateSelectionSummary();
                if (state.cmsLevel && state.identity) {
                    renderAllServices();
                    calculate();
                }
            };

            $('resetBtn').onclick = function () {
                state.cmsLevel = null;
                state.identity = null;
                state.hasForeign = false;
                state.quantities = {};
                
                $('foreignToggle').classList.remove('active');
                $('foreignNote').style.display = 'none';
                $('bcCalcDetail').classList.add('hidden');
                $('gCalcDetail').classList.add('hidden');
                $('scCalcDetail').classList.add('hidden');
                $('grandTotalContent').innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;font-size:0.85rem;">Ë´ãÂÖàÈÅ∏Êìá CMS Á≠âÁ¥öËàáË∫´‰ªΩÂà•</div>';
                
                renderCMS();
                renderIdentity();
                updateStepIndicators();
                updateSelectionSummary();
                
                showToast('Â∑≤Ê∏ÖÈô§ÂÖ®ÈÉ®');
            };

            $('copyBtn').onclick = function () {
                if (!state.cmsLevel || !state.identity) {
                    showToast('Ë´ãÂÖàÂÆåÊàêË®≠ÂÆö');
                    return;
                }

                const bcItems = getAllBcServices();
                const gItems = getAllGServices();
                const scItems = getAllScServices();
                const rateBc = COPAY_RATES.bc[state.identity] / 100;
                const rateG = COPAY_RATES.g[state.identity] / 100;
                const rateSc = COPAY_RATES.sc[state.identity] / 100;
                const rateD = COPAY_RATES.d[state.identity] / 100;

                let quotaBc = CMS_BC_QUOTA[state.cmsLevel];
                if (state.hasForeign) quotaBc = Math.floor(quotaBc * 0.3);
                const quotaG = CMS_G_QUOTA[state.cmsLevel];
                const quotaSc = state.hasForeign ? CMS_SC_QUOTA[state.cmsLevel] : 0;

                let bcTotal = 0, gTotal = 0, scTotal = 0;
                const bcLines = [], gLines = [], scLines = [];

                Object.entries(state.quantities).forEach(([code, qty]) => {
                    if (qty <= 0) return;
                    
                    const bcItem = bcItems.find(s => s.code === code);
                    if (bcItem && bcItem.price > 0) {
                        if (state.hasForeign && !isForeignAllowed(code)) return;
                        const subtotal = bcItem.price * qty;
                        const copayUnit = Math.floor(bcItem.price * rateBc);
                        const copayTotal = Math.floor(subtotal * rateBc);
                        bcTotal += subtotal;
                        bcLines.push('‚Ä¢ ' + code + ' ' + bcItem.name);
                        bcLines.push('  ÂñÆÂÉπ $' + bcItem.price.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayUnit.toLocaleString() + 'Ôºâ');
                        bcLines.push('  ' + qty + 'ÁµÑ $' + subtotal.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayTotal.toLocaleString() + 'Ôºâ');
                        return;
                    }

                    const gItem = gItems.find(s => s.code === code);
                    if (gItem) {
                        const subtotal = gItem.price * qty;
                        const copayUnit = Math.floor(gItem.price * rateG);
                        const copayTotal = Math.floor(subtotal * rateG);
                        gTotal += subtotal;
                        gLines.push('‚Ä¢ ' + code + ' ' + gItem.name);
                        gLines.push('  ÂñÆÂÉπ $' + gItem.price.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayUnit.toLocaleString() + 'Ôºâ');
                        gLines.push('  ' + qty + 'ÁµÑ $' + subtotal.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayTotal.toLocaleString() + 'Ôºâ');
                        return;
                    }

                    // SCÁ¢º
                    if (state.hasForeign) {
                        const scItem = scItems.find(s => s.code === code);
                        if (scItem) {
                            const subtotal = scItem.price * qty;
                            const copayUnit = Math.floor(scItem.price * rateSc);
                            const copayTotal = Math.floor(subtotal * rateSc);
                            scTotal += subtotal;
                            scLines.push('‚Ä¢ ' + code + ' ' + scItem.name);
                            scLines.push('  ÂñÆÂÉπ $' + scItem.price.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayUnit.toLocaleString() + 'Ôºâ');
                            scLines.push('  ' + qty + 'ÁµÑ $' + subtotal.toLocaleString() + 'ÔºàËá™Ë≤† $' + copayTotal.toLocaleString() + 'Ôºâ');
                        }
                    }
                });

                // B/CÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let bcCopay;
                let bcCopayText;
                if (bcTotal <= quotaBc) {
                    bcCopay = Math.floor(bcTotal * rateBc);
                    bcCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateBc * 100) + '%ÔºâÔºö' + bcCopay.toLocaleString() + 'ÂÖÉ';
                } else {
                    const overQuota = bcTotal - quotaBc;
                    bcCopay = Math.floor(quotaBc * rateBc) + overQuota;
                    bcCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâÔºö' + bcCopay.toLocaleString() + 'ÂÖÉ';
                }
                
                // GÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let gCopay;
                let gCopayText;
                if (gTotal <= quotaG) {
                    gCopay = Math.floor(gTotal * rateG);
                    gCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateG * 100) + '%ÔºâÔºö' + gCopay.toLocaleString() + 'ÂÖÉ';
                } else {
                    const overQuota = gTotal - quotaG;
                    gCopay = Math.floor(quotaG * rateG) + overQuota;
                    gCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâÔºö' + gCopay.toLocaleString() + 'ÂÖÉ';
                }

                // SCÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let scCopay = 0;
                let scCopayText = '';
                if (state.hasForeign && quotaSc > 0) {
                    if (scTotal <= quotaSc) {
                        scCopay = Math.floor(scTotal * rateSc);
                        scCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateSc * 100) + '%ÔºâÔºö' + scCopay.toLocaleString() + 'ÂÖÉ';
                    } else {
                        const overQuota = scTotal - quotaSc;
                        scCopay = Math.floor(quotaSc * rateSc) + overQuota;
                        scCopayText = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâÔºö' + scCopay.toLocaleString() + 'ÂÖÉ';
                    }
                }
                
                const dCopay = Math.floor(D_QUOTA * rateD);

                const lines = [
                    '„ÄêÈï∑ÁÖßÈ°çÂ∫¶Ë®àÁÆó„Äë',
                    'CMSÁ≠âÁ¥öÔºö' + state.cmsLevel + 'Á¥ö',
                    'Ë∫´‰ªΩÂà•Ôºö' + IDENTITY_NAMES[state.identity],
                    state.hasForeign ? '‚Äª ËÅòÂÉ±Â§ñÁ±çÁúãË≠∑Â∑•' : '',
                    ''
                ].filter(Boolean);

                lines.push('‚ïê‚ïê‚ïê B/CÁ¢º ÁÖßÈ°ßÂèäÂ∞àÊ•≠ÊúçÂãô ‚ïê‚ïê‚ïê');
                lines.push('ÊúàÈ°çÂ∫¶Ôºö' + quotaBc.toLocaleString() + 'ÂÖÉ' + (state.hasForeign ? 'ÔºàÂ§ñÁ±ç30%Ôºâ' : ''));
                if (bcLines.length > 0) {
                    lines.push('');
                    lines.push(...bcLines);
                    lines.push('');
                }
                lines.push('Â∑≤‰ΩøÁî®Ôºö' + bcTotal.toLocaleString() + 'ÂÖÉ');
                lines.push('Ââ©È§òÔºö' + (quotaBc - bcTotal).toLocaleString() + 'ÂÖÉ');
                lines.push(bcCopayText);
                lines.push('');

                lines.push('‚ïê‚ïê‚ïê DÁ¢º ‰∫§ÈÄöÊé•ÈÄÅ ‚ïê‚ïê‚ïê');
                lines.push('ÊúàÈ°çÂ∫¶Ôºö' + D_QUOTA.toLocaleString() + 'ÂÖÉ');
                lines.push('ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateD * 100) + '%ÔºâÔºö' + dCopay.toLocaleString() + 'ÂÖÉ');
                lines.push('');

                lines.push('‚ïê‚ïê‚ïê GÁ¢º ÂñòÊÅØÊúçÂãô ‚ïê‚ïê‚ïê');
                lines.push('Âπ¥È°çÂ∫¶Ôºö' + quotaG.toLocaleString() + 'ÂÖÉ');
                if (gLines.length > 0) {
                    lines.push('');
                    lines.push(...gLines);
                    lines.push('');
                }
                lines.push('Â∑≤‰ΩøÁî®Ôºö' + gTotal.toLocaleString() + 'ÂÖÉ');
                lines.push('Ââ©È§òÔºö' + (quotaG - gTotal).toLocaleString() + 'ÂÖÉ');
                lines.push(gCopayText);
                lines.push('');

                // SCÁ¢ºÂçÄÂ°äÔºàÂÉÖÂú®ÊúâÂ§ñÁ±çÁúãË≠∑Â∑•ÊôÇÈ°ØÁ§∫Ôºâ
                if (state.hasForeign) {
                    lines.push('‚ïê‚ïê‚ïê SCÁ¢º Áü≠ÁÖßÊúçÂãô ‚ïê‚ïê‚ïê');
                    lines.push('Âπ¥È°çÂ∫¶Ôºö' + quotaSc.toLocaleString() + 'ÂÖÉ');
                    if (scLines.length > 0) {
                        lines.push('');
                        lines.push(...scLines);
                        lines.push('');
                    }
                    lines.push('Â∑≤‰ΩøÁî®Ôºö' + scTotal.toLocaleString() + 'ÂÖÉ');
                    lines.push('Ââ©È§òÔºö' + (quotaSc - scTotal).toLocaleString() + 'ÂÖÉ');
                    lines.push(scCopayText);
                    lines.push('');
                }

                lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                lines.push('Á∏ΩÈÉ®ÂàÜË≤†ÊìîÔºö' + (bcCopay + dCopay + gCopay + scCopay).toLocaleString() + 'ÂÖÉ');

                navigator.clipboard.writeText(lines.join('\n')).then(() => {
                    showToast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
                }).catch(() => {
                    showToast('Ë§áË£ΩÂ§±Êïó');
                });
            };

            $('exportBtn').onclick = async function () {
                if (!state.cmsLevel || !state.identity) {
                    showToast('Ë´ãÂÖàÂÆåÊàêË®≠ÂÆö');
                    return;
                }

                showToast('Ê≠£Âú®ÁîüÊàêÂúñÁâá...');

                const bcItems = getAllBcServices();
                const gItems = getAllGServices();
                const scItems = getAllScServices();
                const rateBc = COPAY_RATES.bc[state.identity] / 100;
                const rateG = COPAY_RATES.g[state.identity] / 100;
                const rateSc = COPAY_RATES.sc[state.identity] / 100;
                const rateD = COPAY_RATES.d[state.identity] / 100;

                let quotaBc = CMS_BC_QUOTA[state.cmsLevel];
                if (state.hasForeign) quotaBc = Math.floor(quotaBc * 0.3);
                const quotaG = CMS_G_QUOTA[state.cmsLevel];
                const quotaSc = state.hasForeign ? CMS_SC_QUOTA[state.cmsLevel] : 0;

                let bcTotal = 0, gTotal = 0, scTotal = 0;
                const bcSelected = [], gSelected = [], scSelected = [];

                Object.entries(state.quantities).forEach(([code, qty]) => {
                    if (qty <= 0) return;
                    
                    const bcItem = bcItems.find(s => s.code === code);
                    if (bcItem && bcItem.price > 0) {
                        if (state.hasForeign && !isForeignAllowed(code)) return;
                        const subtotal = bcItem.price * qty;
                        bcTotal += subtotal;
                        bcSelected.push({ ...bcItem, qty, subtotal });
                        return;
                    }

                    const gItem = gItems.find(s => s.code === code);
                    if (gItem) {
                        const subtotal = gItem.price * qty;
                        gTotal += subtotal;
                        gSelected.push({ ...gItem, qty, subtotal });
                        return;
                    }

                    // SCÁ¢º
                    if (state.hasForeign) {
                        const scItem = scItems.find(s => s.code === code);
                        if (scItem) {
                            const subtotal = scItem.price * qty;
                            scTotal += subtotal;
                            scSelected.push({ ...scItem, qty, subtotal });
                        }
                    }
                });

                // B/CÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let bcCopay, bcCopayLabel;
                if (bcTotal <= quotaBc) {
                    bcCopay = Math.floor(bcTotal * rateBc);
                    bcCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateBc * 100) + '%Ôºâ';
                } else {
                    const overQuota = bcTotal - quotaBc;
                    bcCopay = Math.floor(quotaBc * rateBc) + overQuota;
                    bcCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâ';
                }
                
                // GÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let gCopay, gCopayLabel;
                if (gTotal <= quotaG) {
                    gCopay = Math.floor(gTotal * rateG);
                    gCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateG * 100) + '%Ôºâ';
                } else {
                    const overQuota = gTotal - quotaG;
                    gCopay = Math.floor(quotaG * rateG) + overQuota;
                    gCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâ';
                }

                // SCÁ¢ºÈÉ®ÂàÜË≤†ÊìîË®àÁÆóÔºàË∂ÖÈ°çÈÉ®ÂàÜÁÆó100%Ôºâ
                let scCopay = 0, scCopayLabel = '';
                if (state.hasForeign && quotaSc > 0) {
                    if (scTotal <= quotaSc) {
                        scCopay = Math.floor(scTotal * rateSc);
                        scCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateSc * 100) + '%Ôºâ';
                    } else {
                        const overQuota = scTotal - quotaSc;
                        scCopay = Math.floor(quotaSc * rateSc) + overQuota;
                        scCopayLabel = 'ÈÉ®ÂàÜË≤†ÊìîÔºàÂê´Ë∂ÖÈ°ç' + overQuota.toLocaleString() + 'ÂÖÉÔºâ';
                    }
                }
                
                const dCopay = Math.floor(D_QUOTA * rateD);
                const totalCopay = bcCopay + dCopay + gCopay + scCopay;

                const now = new Date();
                const dateStr = now.getFullYear() + '/' + (now.getMonth() + 1) + '/' + now.getDate();

                // ÁîüÊàêÂåØÂá∫ÂÖßÂÆπ
                let html = '';
                html += '<div class="export-header">';
                html += '<h1>Èï∑ÁÖßÊúçÂãôÈ°çÂ∫¶Ë©¶ÁÆó</h1>';
                html += '<div class="date">Ë®àÁÆóÊó•ÊúüÔºö' + dateStr + '</div>';
                html += '</div>';

                // Âü∫Êú¨Ë≥áË®ä
                html += '<div class="export-section">';
                html += '<div class="export-section-title">Âü∫Êú¨Ë≥áË®ä</div>';
                html += '<div class="export-row"><span class="export-row-label">CMSÁ≠âÁ¥ö</span><span class="export-row-value">' + state.cmsLevel + 'Á¥ö</span></div>';
                html += '<div class="export-row"><span class="export-row-label">Ë∫´‰ªΩÂà•</span><span class="export-row-value">' + IDENTITY_NAMES[state.identity] + '</span></div>';
                if (state.hasForeign) {
                    html += '<div class="export-row"><span class="export-row-label">Â§ñÁ±çÁúãË≠∑</span><span class="export-row-value orange">ÊòØÔºàB/CÁ¢ºÈ°çÂ∫¶30%Ôºâ</span></div>';
                }
                html += '</div>';

                // B/CÁ¢º
                html += '<div class="export-section">';
                html += '<div class="export-section-title">B/CÁ¢º ÁÖßÈ°ßÂèäÂ∞àÊ•≠ÊúçÂãôÔºàÊúàÈ°çÂ∫¶Ôºâ</div>';
                html += '<div class="export-row"><span class="export-row-label">ÊúàÈ°çÂ∫¶</span><span class="export-row-value">' + quotaBc.toLocaleString() + ' ÂÖÉ</span></div>';
                
                if (bcSelected.length > 0) {
                    bcSelected.forEach(item => {
                        html += '<div class="export-item">';
                        html += '<div class="export-item-header">';
                        html += '<span class="export-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>';
                        html += '</div>';
                        html += '<div class="export-item-detail">$' + item.price.toLocaleString() + ' √ó ' + item.qty + 'ÁµÑ = $' + item.subtotal.toLocaleString() + '</div>';
                        html += '</div>';
                    });
                }
                
                html += '<div class="export-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">';
                html += '<span class="export-row-label">Â∑≤‰ΩøÁî®</span><span class="export-row-value highlight">' + bcTotal.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '<div class="export-row"><span class="export-row-label">Ââ©È§òÈ°çÂ∫¶</span><span class="export-row-value ' + (quotaBc - bcTotal >= 0 ? 'green' : 'red') + '">' + (quotaBc - bcTotal).toLocaleString() + ' ÂÖÉ</span></div>';
                html += '<div class="export-row"><span class="export-row-label">' + bcCopayLabel + '</span><span class="export-row-value orange">' + bcCopay.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '</div>';

                // DÁ¢º
                html += '<div class="export-section">';
                html += '<div class="export-section-title cyan">DÁ¢º ‰∫§ÈÄöÊé•ÈÄÅÔºàÊúàÈ°çÂ∫¶Ôºâ</div>';
                html += '<div class="export-row"><span class="export-row-label">ÊúàÈ°çÂ∫¶</span><span class="export-row-value">' + D_QUOTA.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '<div class="export-row"><span class="export-row-label">ÈÉ®ÂàÜË≤†ÊìîÔºà' + (rateD * 100) + '%Ôºâ</span><span class="export-row-value orange">' + dCopay.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '</div>';

                // GÁ¢º
                html += '<div class="export-section">';
                html += '<div class="export-section-title orange">GÁ¢º ÂñòÊÅØÊúçÂãôÔºàÂπ¥È°çÂ∫¶Ôºâ</div>';
                html += '<div class="export-row"><span class="export-row-label">Âπ¥È°çÂ∫¶</span><span class="export-row-value">' + quotaG.toLocaleString() + ' ÂÖÉ</span></div>';
                
                if (gSelected.length > 0) {
                    gSelected.forEach(item => {
                        html += '<div class="export-item">';
                        html += '<div class="export-item-header">';
                        html += '<span class="export-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>';
                        html += '</div>';
                        html += '<div class="export-item-detail">$' + item.price.toLocaleString() + ' √ó ' + item.qty + 'ÁµÑ = $' + item.subtotal.toLocaleString() + '</div>';
                        html += '</div>';
                    });
                }
                
                html += '<div class="export-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">';
                html += '<span class="export-row-label">Â∑≤‰ΩøÁî®</span><span class="export-row-value highlight">' + gTotal.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '<div class="export-row"><span class="export-row-label">Ââ©È§òÈ°çÂ∫¶</span><span class="export-row-value ' + (quotaG - gTotal >= 0 ? 'green' : 'red') + '">' + (quotaG - gTotal).toLocaleString() + ' ÂÖÉ</span></div>';
                html += '<div class="export-row"><span class="export-row-label">' + gCopayLabel + '</span><span class="export-row-value orange">' + gCopay.toLocaleString() + ' ÂÖÉ</span></div>';
                html += '</div>';

                // SCÁ¢ºÔºàÂÉÖÂú®ÊúâÂ§ñÁ±çÁúãË≠∑Â∑•ÊôÇÈ°ØÁ§∫Ôºâ
                if (state.hasForeign) {
                    html += '<div class="export-section">';
                    html += '<div class="export-section-title" style="color:#22d3ee;">SCÁ¢º Áü≠ÁÖßÊúçÂãôÔºàÂπ¥È°çÂ∫¶Ôºâ</div>';
                    html += '<div class="export-row"><span class="export-row-label">Âπ¥È°çÂ∫¶</span><span class="export-row-value">' + quotaSc.toLocaleString() + ' ÂÖÉ</span></div>';
                    
                    if (scSelected.length > 0) {
                        scSelected.forEach(item => {
                            html += '<div class="export-item">';
                            html += '<div class="export-item-header">';
                            html += '<span class="export-item-name"><span class="code">' + item.code + '</span>' + item.name + '</span>';
                            html += '</div>';
                            html += '<div class="export-item-detail">$' + item.price.toLocaleString() + ' √ó ' + item.qty + 'ÁµÑ = $' + item.subtotal.toLocaleString() + '</div>';
                            html += '</div>';
                        });
                    }
                    
                    html += '<div class="export-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">';
                    html += '<span class="export-row-label">Â∑≤‰ΩøÁî®</span><span class="export-row-value highlight">' + scTotal.toLocaleString() + ' ÂÖÉ</span></div>';
                    html += '<div class="export-row"><span class="export-row-label">Ââ©È§òÈ°çÂ∫¶</span><span class="export-row-value ' + (quotaSc - scTotal >= 0 ? 'green' : 'red') + '">' + (quotaSc - scTotal).toLocaleString() + ' ÂÖÉ</span></div>';
                    html += '<div class="export-row"><span class="export-row-label">' + scCopayLabel + '</span><span class="export-row-value orange">' + scCopay.toLocaleString() + ' ÂÖÉ</span></div>';
                    html += '</div>';
                }

                // Á∏ΩË®à
                html += '<div class="export-total">';
                html += '<div class="export-total-row">';
                html += '<span class="export-total-label">ÂÆ∂Â±¨ÈúÄÊîØ‰ªòÈÉ®ÂàÜË≤†Êìî</span>';
                html += '<span class="export-total-value">' + totalCopay.toLocaleString() + ' ÂÖÉ</span>';
                html += '</div>';
                html += '</div>';

                html += '<div class="export-footer">Ê≠§ÁÇ∫Ë©¶ÁÆóÁµêÊûúÔºåÂØ¶ÈöõË≤ªÁî®‰ª•ÊúçÂãôÂñÆ‰ΩçË´ãÊ¨æÁÇ∫Ê∫ñ</div>';

                const canvas = $('exportCanvas');
                canvas.innerHTML = html;

                try {
                    await document.fonts.ready;
                    
                    const canvasEl = await html2canvas(canvas, {
                        scale: 2,
                        backgroundColor: null,
                        logging: false,
                        useCORS: true
                    });

                    const link = document.createElement('a');
                    link.download = 'Èï∑ÁÖßÈ°çÂ∫¶Ë©¶ÁÆó_' + dateStr.replace(/\//g, '') + '.png';
                    link.href = canvasEl.toDataURL('image/png');
                    link.click();

                    showToast('ÂúñÁâáÂ∑≤‰∏ãËºâ');
                } catch (err) {
                    console.error(err);
                    showToast('ÂåØÂá∫Â§±Êïó');
                }
            };

            // ÂàùÂßãÁãÄÊÖãÁöÑÁ∏ΩË¶Ω
            $('grandTotalContent').innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;font-size:0.85rem;">Ë´ãÂÖàÈÅ∏Êìá CMS Á≠âÁ¥öËàáË∫´‰ªΩÂà•</div>';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
